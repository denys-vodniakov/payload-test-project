{
  "id": "20251128_142515",
  "up": "CREATE OR REPLACE FUNCTION safe_text_to_jsonb_for_options(input_text text)\nRETURNS jsonb AS $$\nBEGIN\n  -- If input is null or empty, return empty Lexical structure\n  IF input_text IS NULL OR input_text = '' THEN\n    RETURN jsonb_build_object(\n      'root', \n      jsonb_build_object(\n        'children', \n        jsonb_build_array(),\n        'type', 'root',\n        'direction', 'ltr',\n        'format', '',\n        'indent', 0,\n        'version', 1\n      )\n    );\n  END IF;\n\n  -- Try to parse as JSON if it looks like JSON\n  IF input_text ~ '^[\\s]*[\\{\\[]' THEN\n    BEGIN\n      RETURN input_text::jsonb;\n    EXCEPTION WHEN OTHERS THEN\n      -- If parsing fails, wrap plain text in Lexical paragraph format\n      RETURN jsonb_build_object(\n        'root', \n        jsonb_build_object(\n          'children', \n          jsonb_build_array(\n            jsonb_build_object(\n              'children',\n              jsonb_build_array(\n                jsonb_build_object('text', input_text, 'type', 'text', 'format', 0, 'style', '')\n              ),\n              'type', 'paragraph',\n              'direction', 'ltr',\n              'format', '',\n              'indent', 0\n            )\n          ),\n          'type', 'root',\n          'direction', 'ltr',\n          'format', '',\n          'indent', 0,\n          'version', 1\n        )\n      );\n    END;\n  ELSE\n    -- Wrap plain text in Lexical paragraph format\n    RETURN jsonb_build_object(\n      'root', \n      jsonb_build_object(\n        'children', \n        jsonb_build_array(\n          jsonb_build_object(\n            'children',\n            jsonb_build_array(\n              jsonb_build_object('text', input_text, 'type', 'text', 'format', 0, 'style', '')\n            ),\n            'type', 'paragraph',\n            'direction', 'ltr',\n            'format', '',\n            'indent', 0\n          )\n        ),\n        'type', 'root',\n        'direction', 'ltr',\n        'format', '',\n        'indent', 0,\n        'version', 1\n      )\n    );\n  END IF;\nEND;\n$$ LANGUAGE plpgsql;\n\nDO $$ \nDECLARE\n  col_type text;\nBEGIN\n  -- Get current column type\n  SELECT data_type INTO col_type\n  FROM information_schema.columns \n  WHERE table_name = 'questions_options' AND column_name = 'text';\n  \n  -- Only convert if not already jsonb\n  IF col_type IS NOT NULL AND col_type != 'jsonb' THEN\n    ALTER TABLE \"questions_options\" \n    ALTER COLUMN \"text\" TYPE jsonb \n    USING safe_text_to_jsonb_for_options(\"text\"::text);\n  END IF;\nEND $$;\n\nDROP FUNCTION IF EXISTS safe_text_to_jsonb_for_options(text);"
}

